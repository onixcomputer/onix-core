# Vault Auto-Initialization with Clan Vars

This Vault module now supports automatic initialization using clan vars to manage tokens and keys.

## How it Works

1. **Token Generation**: When you run `clan vars generate britton-fw --generator vault-init`, clan creates a secure root token for Vault.

2. **Automatic Initialization**: On first boot, if `autoInit.enable = true` is set in the configuration, the vault-auto-init service will:
   - Wait for Vault to start
   - Check if Vault is already initialized
   - If not initialized, run `vault operator init` to initialize Vault
   - Save the generated unseal keys back to clan vars
   - Automatically unseal Vault using the first 3 keys

3. **Auto-Unseal on Restart**: When Vault restarts (already initialized), the service will:
   - Check if Vault is sealed
   - Read the stored unseal keys from clan vars
   - Automatically unseal using the stored keys

## Usage

1. Enable auto-initialization in your inventory:
   ```nix
   settings = {
     autoInit = {
       enable = true;
     };
   };
   ```

2. Generate the initial token:
   ```bash
   clan vars generate britton-fw --generator vault-init
   ```

3. Deploy:
   ```bash
   clan machines update britton-fw
   ```

4. View stored credentials:
   ```bash
   # List all vault secrets
   clan vars list britton-fw --service vault-init
   
   # Get the root token (for initial setup)
   clan vars get britton-fw --service vault-init root_token
   ```

## Security Notes

- The root token is generated locally by clan vars, not by Vault
- Unseal keys are generated by Vault during initialization
- All keys are encrypted with SOPS and stored in clan's secret management
- The root token should only be used for initial setup, then revoked
- Create separate tokens with limited policies for applications

## Manual Operations

If needed, you can still manually initialize Vault:
1. Disable autoInit in the configuration
2. Run `vault operator init` manually
3. Store the keys securely